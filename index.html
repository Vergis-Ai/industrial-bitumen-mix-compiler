<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PMB Bitumen Mix Chart</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 900px;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-slate-100 flex flex-col items-center justify-center p-6">
    <div class="container bg-white rounded-3xl shadow-xl p-8 max-w-lg w-full md:max-w-3xl lg:max-w-4xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2 md:text-4xl">PMB Bitumen Mix Chart</h1>
        <p class="text-center text-gray-500 mb-8 max-w-md mx-auto">Enter the percentages of each component to see how the mix's qualities change in real time.</p>

        <!-- Status and User ID display -->
        <div class="mb-4 text-center">
            <p id="userIdDisplay" class="text-sm font-medium text-gray-500 break-all"></p>
            <div id="statusMessage" class="mt-2 p-2 rounded-lg text-sm text-gray-800 bg-gray-200">
                Connecting to database...
            </div>
        </div>

        <!-- Input Fields Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-4">
            <!-- Component 1: C170 Bitumen -->
            <div class="bg-gray-50 p-6 rounded-2xl shadow-inner input-group">
                <label for="c170Bitumen" class="text-gray-700 font-medium">C170 Bitumen (%)</label>
                <input type="number" id="c170Bitumen" name="c170Bitumen" min="0" max="100" value="70" class="w-full p-2 rounded-lg border-2 border-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors">
            </div>

            <!-- Component 2: LG411 Radial -->
            <div class="bg-gray-50 p-6 rounded-2xl shadow-inner input-group">
                <label for="sbs" class="text-gray-700 font-medium">LG411 Radial (%)</label>
                <input type="number" id="sbs" name="sbs" min="0" max="100" value="15" class="w-full p-2 rounded-lg border-2 border-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors">
            </div>

            <!-- Component 3: Ha32 Combining oil -->
            <div class="bg-gray-50 p-6 rounded-2xl shadow-inner input-group">
                <label for="ha32CombiningOil" class="text-gray-700 font-medium">Ha32 Combining Oil (%)</label>
                <input type="number" id="ha32CombiningOil" name="ha32CombiningOil" min="0" max="100" value="10" class="w-full p-2 rounded-lg border-2 border-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors">
            </div>

            <!-- Component 4: Bitlinker -->
            <div class="bg-gray-50 p-6 rounded-2xl shadow-inner input-group">
                <label for="bitlinker" class="text-gray-700 font-medium">Ravasol™ BITLINKER-S6F (%)</label>
                <input type="number" id="bitlinker" name="bitlinker" min="0" max="100" value="5" class="w-full p-2 rounded-lg border-2 border-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors">
            </div>
        </div>

        <!-- Total Percentage Display -->
        <div class="text-center mb-8 font-bold flex flex-col sm:flex-row items-center justify-center gap-4">
            <span id="totalPercentage" class="text-2xl text-gray-800">Total: 100%</span>
            <span id="remaining" class="text-2xl text-gray-500">Remaining: 0%</span>
            <button id="resetButton" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200">
                Reset to Default
            </button>
        </div>

        <!-- Chart and Qualities Section -->
        <div class="flex flex-col lg:flex-row items-center lg:items-start justify-center gap-8 lg:gap-12">
            <!-- Radar Chart -->
            <div class="w-full lg:w-1/2 p-6 bg-white rounded-3xl shadow-xl flex-shrink-0">
                <canvas id="qualityChart"></canvas>
            </div>

            <!-- Qualities List -->
            <div class="w-full lg:w-1/2 mt-6 lg:mt-0">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center lg:text-left">Mix Qualities</h2>
                <div id="qualitiesList" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- Quality items will be dynamically added here -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        setLogLevel('Debug');

        // Mapping of components to their qualities. Values are relative weights.
        const components = {
            c170Bitumen: {
                name: 'C170 Bitumen',
                qualities: {
                    Adhesion: 0.5,
                    Durability: 0.6,
                    Flexibility: 0.3,
                    TemperatureResistance: 0.4,
                    AgingResistance: 0.5,
                    SettingTime: 0.8,
                    Viscosity: 0.7
                },
                defaultValue: 70
            },
            sbs: {
                name: 'LG411 Radial',
                qualities: {
                    Adhesion: 0.8,
                    Durability: 0.9,
                    Flexibility: 1.0,
                    TemperatureResistance: 0.9,
                    AgingResistance: 0.9,
                    SettingTime: 0.6,
                    Viscosity: 0.9
                },
                defaultValue: 15,
                // The following data is included for reference and potential future display
                data: {
                    Structure: 'Radial',
                    StyreneContent: '31.0%',
                    Density: '0.94 g/㎤',
                    TSV: '28.2 cSt',
                    Hardness: '84 Shore A',
                    VolatileMatter: '< 0.6%',
                    YellowIndex: 'ASTM D1925'
                }
            },
            ha32CombiningOil: {
                name: 'Ha32 Combining Oil',
                // Low viscosity and liquid form increase flexibility and workability.
                qualities: {
                    Adhesion: 0.8,
                    Durability: 0.3,
                    Flexibility: 0.7,
                    TemperatureResistance: 0.5,
                    AgingResistance: 0.7,
                    SettingTime: 1.0,
                    Viscosity: 0.2
                },
                defaultValue: 10,
                // The following data is included for reference and potential future display
                data: {
                    Form: 'Liquid',
                    Colour: 'N Av',
                    Odour: 'Negligible',
                    Solubility: 'Insoluble in water',
                    Density: '0.86 kg/L @ 15 °C',
                    RelativeVapourDensity: '>1',
                    VapourPressure: '<0.1 mmHg @ 20 °C',
                    FlashPoint: '>200 °C',
                    FlammabilityLimits: 'N App',
                    AutoignitionTemperature: 'N Av',
                    MeltingPoint: 'N Av',
                    BoilingPoint: '>350 °C',
                    pH: 'N App',
                    Viscosity_40C: '28-35 cSt @ 40 °C',
                    Viscosity_100C: '4.9-5.9 cSt @ 100 °C',
                    TotalVOC: 'N Av'
                }
            },
            bitlinker: {
                name: 'Ravasol™ BITLINKER-S6F',
                // Qualities reflecting its role as a granular stabilizer with high temperature stability.
                qualities: {
                    Adhesion: 0.6,
                    Durability: 0.8,
                    Flexibility: 0.2,
                    TemperatureResistance: 0.9,
                    AgingResistance: 0.9,
                    SettingTime: 0.3,
                    Viscosity: 0.8
                },
                defaultValue: 5,
                // The following data is included for reference and potential future display
                data: {
                    Appearance: 'Granular',
                    Colour: 'Blue',
                    Odour: 'Odourless',
                    MeltingPoint: '80-120 °C',
                    FlashPoint: '>230 °C',
                    RelativeDensity: '0.63 g/cm³',
                    Solubility: 'N.A./N.A.'
                }
            }
        };

        // Global variables for Firebase services and user ID
        let db;
        let auth;
        let userId;

        const inputIds = ['c170Bitumen', 'sbs', 'ha32CombiningOil', 'bitlinker'];
        let myChart;
        const statusMessageDiv = document.getElementById('statusMessage');
        const userIdDisplay = document.getElementById('userIdDisplay');

        // Simple debounce function to limit database writes
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // Function to show status messages
        function showStatus(message, isError = false) {
            statusMessageDiv.textContent = message;
            if (isError) {
                statusMessageDiv.className = 'mt-2 p-2 rounded-lg text-sm bg-red-200 text-red-800';
            } else {
                statusMessageDiv.className = 'mt-2 p-2 rounded-lg text-sm bg-gray-200 text-gray-800';
            }
        }

        // Function to calculate the total qualities based on current percentages
        function calculateQualities() {
            const finalQualities = {};
            const qualityKeys = Object.keys(Object.values(components)[0].qualities);
            qualityKeys.forEach(key => finalQualities[key] = 0);

            let totalPercentage = 0;
            for (const inputId of inputIds) {
                const percentage = parseFloat(document.getElementById(inputId).value) || 0;
                totalPercentage += percentage;
            }

            // Calculate weighted sum of qualities
            for (const inputId of inputIds) {
                const percentage = parseFloat(document.getElementById(inputId).value) || 0;
                const component = components[inputId];
                for (const quality in component.qualities) {
                    finalQualities[quality] += component.qualities[quality] * percentage / 100;
                }
            }

            // Normalize values to a 0-100 scale for the chart
            const finalValues = {};
            for (const quality in finalQualities) {
                // Adjust values based on the current total to keep the chart visually stable.
                const adjustmentFactor = totalPercentage > 0 ? 100 / totalPercentage : 1;
                finalValues[quality] = Math.round(finalQualities[quality] * adjustmentFactor * 100);
            }
            return finalValues;
        }

        const updateValuesAndSave = debounce(() => {
            updateInputs();
            
            // Save data to Firestore
            if (!userId) {
                showStatus('User not authenticated, skipping save.', true);
                return;
            }
            
            const blendingData = {};
            inputIds.forEach(id => {
                blendingData[id] = parseFloat(document.getElementById(id).value) || 0;
            });

            const userDocRef = doc(db, 'artifacts', appId, 'users', userId, 'blending_data', 'current');
            showStatus('Saving...');
            setDoc(userDocRef, blendingData)
            .then(() => {
                showStatus('Saved successfully!');
            }).catch((error) => {
                showStatus('Save failed: ' + error.message, true);
            });
        }, 500);

        function updateChart() {
            const qualities = calculateQualities();
            myChart.data.datasets[0].data = Object.values(qualities);
            myChart.update();
            updateQualitiesList(qualities);
        }

        function updateInputs() {
            let total = 0;
            inputIds.forEach(id => {
                const value = parseFloat(document.getElementById(id).value) || 0;
                total += value;
            });
            total = parseFloat(total.toFixed(2));

            document.getElementById('totalPercentage').textContent = `Total: ${total}%`;
            const remaining = parseFloat((100 - total).toFixed(2));
            const remainingElement = document.getElementById('remaining');
            remainingElement.textContent = `Remaining: ${remaining}%`;

            if (remaining === 0) {
                remainingElement.classList.remove('text-red-500');
                remainingElement.classList.add('text-green-500');
            } else {
                remainingElement.classList.remove('text-green-500');
                remainingElement.classList.add('text-red-500');
            }
            updateChart();
        }

        function resetToDefault() {
            inputIds.forEach(id => {
                const input = document.getElementById(id);
                input.value = components[id].defaultValue;
            });
            updateValuesAndSave();
        }

        function updateQualitiesList(qualities) {
            const listContainer = document.getElementById('qualitiesList');
            listContainer.innerHTML = '';
            for (const quality in qualities) {
                const item = document.createElement('div');
                item.className = 'bg-gray-100 p-4 rounded-xl shadow-sm flex items-center justify-between transition-all duration-300 transform hover:scale-105';
                const qualityName = document.createElement('span');
                qualityName.className = 'text-gray-700 font-semibold';
                qualityName.textContent = quality.replace(/([A-Z])/g, ' $1').trim();
                const qualityValue = document.createElement('span');
                qualityValue.className = 'text-lg font-bold text-indigo-600';
                qualityValue.textContent = qualities[quality] + '%';
                item.appendChild(qualityName);
                item.appendChild(qualityValue);
                listContainer.appendChild(item);
            }
        }

        // Initialize Firebase and Authentication
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{"projectId": "default-project-id"}');

        const initializeFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID: ${userId}`;
                        const userDocRef = doc(db, 'artifacts', appId, 'users', userId, 'blending_data', 'current');
                        loadValues(userDocRef);
                    } else {
                        userId = null;
                        userIdDisplay.textContent = 'User ID: N/A';
                        showStatus('Signed out or failed to authenticate.', true);
                    }
                });
            } catch (error) {
                showStatus('Firebase initialization failed: ' + error.message, true);
            }
        };

        const loadValues = (docRef) => {
            showStatus('Loading previous session...');
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    inputIds.forEach(id => {
                        const input = document.getElementById(id);
                        if(data[id] !== undefined) {
                            input.value = data[id];
                        }
                    });
                    updateInputs();
                    showStatus('Session loaded successfully!');
                } else {
                    showStatus('No previous session found. Starting fresh.');
                }
            }, (error) => {
                showStatus('Load failed: ' + error.message, true);
            });
        };

        window.onload = function () {
            const ctx = document.getElementById('qualityChart').getContext('2d');
            const qualities = calculateQualities();
            const dataValues = Object.values(qualities);
            const qualityLabels = Object.keys(qualities).map(label => label.replace(/([A-Z])/g, ' $1').trim());

            myChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: qualityLabels,
                    datasets: [{
                        label: 'Mix Qualities',
                        data: dataValues,
                        backgroundColor: 'rgba(99, 102, 241, 0.4)',
                        borderColor: 'rgb(99, 102, 241)',
                        pointBackgroundColor: 'rgb(99, 102, 241)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(99, 102, 241)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(0, 0, 0, 0.1)' },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' },
                            pointLabels: {
                                font: { size: 12, weight: 'bold' },
                                color: '#4b5563'
                            },
                            ticks: {
                                beginAtZero: true,
                                max: 100,
                                stepSize: 20,
                                backdropColor: 'transparent',
                                color: '#6b7280'
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.r !== null) {
                                        label += context.parsed.r + '%';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            
            // Add event listeners to all number inputs
            inputIds.forEach(id => {
                const input = document.getElementById(id);
                input.addEventListener('input', updateValuesAndSave);
            });

            document.getElementById('resetButton').addEventListener('click', resetToDefault);

            // Make the chart responsive to window resize
            window.addEventListener('resize', () => {
                myChart.resize();
            });

            initializeFirebase();
        };
    </script>
</body>
</html>
