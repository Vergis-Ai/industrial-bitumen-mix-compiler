import math

# This dictionary holds the base effects of different polymer types.
# The values represent base multipliers for the final quality score.
POLYMER_EFFECTS = {
    'none': {'adhesion': 1, 'durability': 1, 'flexibility': 1, 'tempResistance': 1, 'agingResistance': 1, 'elasticRecovery': 20, 'softeningPoint': 45},
    'sbs': {'adhesion': 1.2, 'durability': 1.15, 'flexibility': 1.3, 'tempResistance': 1.1, 'agingResistance': 1.2, 'elasticRecovery': 70, 'softeningPoint': 70},
    'epr': {'adhesion': 1.1, 'durability': 1.1, 'flexibility': 1.4, 'tempResistance': 1.05, 'agingResistance': 1.1, 'elasticRecovery': 50, 'softeningPoint': 60},
    'app': {'adhesion': 1.3, 'durability': 1.2, 'flexibility': 1.1, 'tempResistance': 1.2, 'agingResistance': 1.3, 'elasticRecovery': 60, 'softeningPoint': 80},
}

# This dictionary holds the additive effects, which are added directly to the quality scores.
ADDITIVE_EFFECTS = {
    'carbon_nanotubes': {'adhesion': 0.05, 'durability': 0.1, 'flexibility': 0.03, 'tempResistance': 0.07, 'agingResistance': 0.1},
    'synthetic_wax': {'adhesion': 0.02, 'durability': 0.05, 'flexibility': 0.04, 'tempResistance': 0.03, 'agingResistance': 0.02},
}

# Default values for all components, matching the original source.
DEFAULTS = {
    'c170_bitumen': 70,
    'sbs': 15,
    'ha32_oil': 10,
    'bitlinker': 5,
    'rap': 0,
    'ras': 0,
    'carbon_nanotubes': False,
    'synthetic_wax': False,
    'saturates': 10,
    'aromatics': 50,
    'resins': 25,
    'asphaltenes': 15,
}

def calculate_mix_qualities(
    c170_bitumen: float,
    sbs: float,
    ha32_oil: float,
    bitlinker: float,
    rap: float,
    ras: float,
    carbon_nanotubes: bool,
    synthetic_wax: bool,
    saturates: float,
    aromatics: float,
    resins: float,
    asphaltenes: float,
    polymer_type: str = 'sbs'
) -> dict:
    """
    Calculates the quality metrics of a bitumen mix based on component percentages.

    Args:
        c170_bitumen (float): Percentage of C170 Bitumen.
        sbs (float): Percentage of SBS.
        ha32_oil (float): Percentage of HA-32 Combining Oil.
        bitlinker (float): Percentage of Bitlinker.
        rap (float): Percentage of Recycled Asphalt Pavement (RAP).
        ras (float): Percentage of Recycled Asphalt Shingles (RAS).
        carbon_nanotubes (bool): Whether Carbon Nanotubes are included.
        synthetic_wax (bool): Whether Synthetic Wax is included.
        saturates (float): Percentage of Saturates in SARA.
        aromatics (float): Percentage of Aromatics in SARA.
        resins (float): Percentage of Resins in SARA.
        asphaltenes (float): Percentage of Asphaltenes in SARA.
        polymer_type (str): The type of polymer used. Defaults to 'sbs'.

    Returns:
        dict: A dictionary containing the calculated quality metrics.
    """
    
    # Check if the main components sum to 100%
    main_total = c170_bitumen + sbs + ha32_oil + bitlinker
    if not math.isclose(main_total, 100, abs_tol=0.1):
        print(f"Warning: Main components sum to {main_total:.2f}%, not 100%. Results may be inaccurate.")
    
    # Check if SARA components sum to 100%
    sara_total = saturates + aromatics + resins + asphaltenes
    if not math.isclose(sara_total, 100, abs_tol=0.1):
        print(f"Warning: SARA components sum to {sara_total:.2f}%, not 100%. Results may be inaccurate.")

    # Get the base effects from the specified polymer type.
    p_effect = POLYMER_EFFECTS.get(polymer_type, POLYMER_EFFECTS['none'])
    
    # Initialize qualities with the base polymer effects.
    qualities = {
        'adhesion': p_effect['adhesion'],
        'durability': p_effect['durability'],
        'flexibility': p_effect['flexibility'],
        'temp_resistance': p_effect['tempResistance'],
        'aging_resistance': p_effect['agingResistance'],
        'elastic_recovery': p_effect['elasticRecovery'],
        'softening_point': p_effect['softeningPoint'],
        'setting_time': 0,
    }

    # Apply additive effects if the corresponding flags are True.
    # The new document "1-s2.0..." notes that chemical additives tend to reduce the effect of ageing.
    # This is now factored into the aging resistance calculation.
    if carbon_nanotubes:
        qualities['adhesion'] += ADDITIVE_EFFECTS['carbon_nanotubes']['adhesion']
        qualities['durability'] += ADDITIVE_EFFECTS['carbon_nanotubes']['durability']
        qualities['flexibility'] += ADDITIVE_EFFECTS['carbon_nanotubes']['flexibility']
        qualities['temp_resistance'] += ADDITIVE_EFFECTS['carbon_nanotubes']['tempResistance']
        qualities['aging_resistance'] += ADDITIVE_EFFECTS['carbon_nanotubes']['agingResistance'] * 1.5  # Increased effect on aging resistance

    if synthetic_wax:
        qualities['adhesion'] += ADDITIVE_EFFECTS['synthetic_wax']['adhesion']
        qualities['durability'] += ADDITIVE_EFFECTS['synthetic_wax']['durability']
        qualities['flexibility'] += ADDITIVE_EFFECTS['synthetic_wax']['flexibility']
        qualities['temp_resistance'] += ADDITIVE_EFFECTS['synthetic_wax']['tempResistance']
        qualities['aging_resistance'] += ADDITIVE_EFFECTS['synthetic_wax']['agingResistance'] * 1.5 # Increased effect on aging resistance

    # Adjust qualities based on SARA component percentages.
    # These effects are scaled by the percentage of each component.
    qualities['adhesion'] += (resins / 100) * 0.1 + (aromatics / 100) * 0.05
    qualities['durability'] += (asphaltenes / 100) * 0.15
    qualities['flexibility'] += (aromatics / 100) * 0.2
    qualities['temp_resistance'] += (asphaltenes / 100) * 0.1
    qualities['aging_resistance'] += (resins / 100) * 0.1 + (asphaltenes / 100) * 0.1

    # Apply a penalty for including recycled materials (RAP and RAS).
    recycled_factor = (rap + ras) / 100
    qualities['adhesion'] -= recycled_factor * 0.1
    qualities['durability'] -= recycled_factor * 0.15
    qualities['flexibility'] -= recycled_factor * 0.2
    qualities['aging_resistance'] -= recycled_factor * 0.2

    # Recalculate Elastic Recovery and Softening Point based on component percentages.
    # The new document provides specific values for a PMB with SBS.
    # We can use these to create a more accurate base for the calculations.
    
    # The paper gives PMB Elastic Recovery of 89% and Softening Point of 71Â°C.
    # We'll use a weighted average based on the ratio of SBS to Bitumen.
    base_softening_point = 71
    base_elastic_recovery = 89
    total_bitumen_and_sbs = c170_bitumen + sbs
    
    if total_bitumen_and_sbs > 0:
        sbs_contribution = sbs / total_bitumen_and_sbs
        bitumen_contribution = c170_bitumen / total_bitumen_and_sbs
        
        qualities['elastic_recovery'] = (base_elastic_recovery * sbs_contribution) + (20 * bitumen_contribution)
        qualities['softening_point'] = (base_softening_point * sbs_contribution) + (45 * bitumen_contribution)
        
    # Calculate setting time and ensure it does not fall below zero.
    qualities['setting_time'] = (sbs * 0.2) + (bitlinker * 0.5) + (rap * 0.1) - (2 if synthetic_wax else 0)
    if qualities['setting_time'] < 0:
        qualities['setting_time'] = 0

    return qualities

if __name__ == "__main__":
    # Example usage with the A15E composition, based on the SDS file.
    # Note: Using the midpoint of the provided ranges for the components.
    print("Bitumen Mix Quality Report (A15E Production)")
    print("------------------------------------------")
    a15e_results = calculate_mix_qualities(
        c170_bitumen=85,  # Midpoint of 81% to <100%
        sbs=5,            # Midpoint of 1% to <10%
        ha32_oil=5,       # Midpoint of 1% to <10%
        bitlinker=5,
        rap=0,
        ras=0,
        carbon_nanotubes=False,
        synthetic_wax=True, # The second document mentions WMA chemical additives
        saturates=10,
        aromatics=50,
        resins=25,
        asphaltenes=15
    )

    for key, value in a15e_results.items():
        if isinstance(value, float):
            print(f"{key.replace('_', ' ').capitalize():<20}: {value:.2f}")
        else:
            print(f"{key.replace('_', ' ').capitalize():<20}: {value}")

    # Example with a custom mix (higher SBS content and additives)
    print("\nBitumen Mix Quality Report (Custom Mix)")
    print("---------------------------------------")
    custom_results = calculate_mix_qualities(
        c170_bitumen=65,
        sbs=20,
        ha32_oil=10,
        bitlinker=5,
        rap=0,
        ras=0,
        carbon_nanotubes=True,
        synthetic_wax=True,
        saturates=10,
        aromatics=50,
        resins=25,
        asphaltenes=15
    )

    for key, value in custom_results.items():
        if isinstance(value, float):
            print(f"{key.replace('_', ' ').capitalize():<20}: {value:.2f}")
        else:
            print(f"{key.replace('_', ' ').capitalize():<20}: {value}")
